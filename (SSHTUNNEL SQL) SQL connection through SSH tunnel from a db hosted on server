import os
import sshtunnel
import MySQLdb
from datetime import datetime

# Assuming you're using python-dotenv or a similar package to load environment variables
from dotenv import load_dotenv
load_dotenv()

def update_access_token(company_name, new_access_token, expires_in):
    """Updates the access token and expiration time in the database for the specified company."""
    try:
#call your env variables for a secure ssh connection
        ssh_username = os.environ.get('SSH_USERNAME')
        ssh_password = os.environ.get('SSH_PASSWORD')
        db_username = os.environ.get('DB_USERNAME')
        db_password = os.environ.get('DB_PASSWORD')
        db_host = os.environ.get('DB_HOST')
        db_name = os.environ.get('DB_NAME')

        sshtunnel.SSH_TIMEOUT = 5.0
        sshtunnel.TUNNEL_TIMEOUT = 5.0

        with sshtunnel.SSHTunnelForwarder(
            ('ssh.pythonanywhere.com', 22),
            ssh_username=ssh_username, ssh_password=ssh_password,
            remote_bind_address=(db_host, 3306)
        ) as tunnel:
            connection = MySQLdb.connect(
                user=db_username,
                passwd=db_password,
                host='127.0.0.1', port=tunnel.local_bind_port,
                db=db_name,
            )

            with connection.cursor() as cursor:
                query = """
                        UPDATE datatosecure
                        SET access_token = %s,  date_of_update = NOW()
                        WHERE email = %s
                        """
                cursor.execute(query, (new_access_token, expires_in, company_name))
                connection.commit()

    except Exception as e:
        print(f"An error occurred while updating the access token: {str(e)}")
